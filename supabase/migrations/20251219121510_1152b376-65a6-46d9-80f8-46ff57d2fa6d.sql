-- Create achievements table (catalog of available achievements)
CREATE TABLE public.achievements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT NOT NULL,
  how_to_earn TEXT NOT NULL,
  icon TEXT NOT NULL,
  badge_color TEXT DEFAULT 'gold',
  category TEXT NOT NULL,
  trigger_type TEXT NOT NULL,
  trigger_value INT,
  sort_order INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Create user_achievements table (unlocked achievements per user)
CREATE TABLE public.user_achievements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.user_profiles(id) ON DELETE CASCADE,
  achievement_id UUID NOT NULL REFERENCES public.achievements(id) ON DELETE CASCADE,
  unlocked_at TIMESTAMPTZ DEFAULT now(),
  shared_at TIMESTAMPTZ,
  UNIQUE(user_id, achievement_id)
);

-- Enable RLS
ALTER TABLE public.achievements ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_achievements ENABLE ROW LEVEL SECURITY;

-- RLS Policies for achievements (everyone can view)
CREATE POLICY "Anyone can view achievements" ON public.achievements
FOR SELECT USING (true);

CREATE POLICY "Admins can insert achievements" ON public.achievements
FOR INSERT WITH CHECK (public.has_role(auth.uid(), 'admin'));

CREATE POLICY "Admins can update achievements" ON public.achievements
FOR UPDATE USING (public.has_role(auth.uid(), 'admin'));

CREATE POLICY "Admins can delete achievements" ON public.achievements
FOR DELETE USING (public.has_role(auth.uid(), 'admin'));

-- RLS Policies for user_achievements
CREATE POLICY "Users can view own achievements" ON public.user_achievements
FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own achievements" ON public.user_achievements
FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Admins can view all user achievements" ON public.user_achievements
FOR SELECT USING (public.has_role(auth.uid(), 'admin'));

-- Seed achievements data
INSERT INTO public.achievements (name, description, how_to_earn, icon, badge_color, category, trigger_type, trigger_value, sort_order) VALUES
-- Streak achievements
('Chispa Inicial', 'Â¡Tu racha estÃ¡ encendida!', 'Completa actividades 3 dÃ­as consecutivos', 'ğŸ”¥', 'orange', 'streak', 'streak_days', 3, 1),
('En Racha', 'Â¡Una semana sin parar!', 'Completa actividades 7 dÃ­as consecutivos', 'âš¡', 'yellow', 'streak', 'streak_days', 7, 2),
('Imparable', 'Â¡Dos semanas de puro fuego!', 'Completa actividades 14 dÃ­as consecutivos', 'ğŸ’¥', 'red', 'streak', 'streak_days', 14, 3),
('Leyenda del Streak', 'Â¡Un mes completo entrenando!', 'Completa actividades 30 dÃ­as consecutivos', 'ğŸŒŸ', 'gold', 'streak', 'streak_days', 30, 4),

-- Milestone achievements
('Primera Zancada', 'Â¡Tu viaje ha comenzado!', 'Completa tu primera actividad', 'ğŸ¯', 'primary', 'milestone', 'activities_count', 1, 10),
('Semana en Llamas', 'Â¡Primera semana completada!', 'Completa tu primera semana de entrenamiento', 'ğŸ”¥', 'orange', 'milestone', 'weeks_complete', 1, 11),

-- High intensity zone achievements
('Velocista Novato', 'Â¡Empezando a acelerar!', 'Completa 5 actividades en zonas ZY/Z4/Z5', 'âš¡', 'yellow', 'intensity_zone', 'high_zone_count', 5, 20),
('Cohete Humano', 'Â¡Velocidad imparable!', 'Completa 15 actividades en zonas ZY/Z4/Z5', 'ğŸš€', 'orange', 'intensity_zone', 'high_zone_count', 15, 21),
('Destructor de Umbrales', 'Â¡Dominas la velocidad!', 'Completa 30 actividades en zonas ZY/Z4/Z5', 'ğŸ’€', 'red', 'intensity_zone', 'high_zone_count', 30, 22),

-- Interval achievements
('Primer Intervalo', 'Â¡Intervalos dominados!', 'Completa 3 entrenamientos de intervalos', 'ğŸ”„', 'primary', 'interval', 'interval_count', 3, 30),
('Rey del Tempo', 'Â¡Maestro del tempo!', 'Completa 10 entrenamientos de intervalos', 'â±ï¸', 'yellow', 'interval', 'interval_count', 10, 31),
('MÃ¡quina de Intervalos', 'Â¡Intervalos son tu especialidad!', 'Completa 25 entrenamientos de intervalos', 'ğŸï¸', 'gold', 'interval', 'interval_count', 25, 32),

-- Long run achievements
('KilÃ³metro Cero', 'Â¡Primeros trotes largos!', 'Completa 3 trotes largos', 'ğŸ›£ï¸', 'primary', 'long_run', 'long_run_count', 3, 40),
('Corredor de Fondo', 'Â¡Resistencia en desarrollo!', 'Completa 10 trotes largos', 'ğŸŒ„', 'orange', 'long_run', 'long_run_count', 10, 41),
('Ultra Resistente', 'Â¡Fondo es tu fortaleza!', 'Completa 20 trotes largos', 'ğŸ”ï¸', 'gold', 'long_run', 'long_run_count', 20, 42),

-- Distance achievements
('Primeros 50K', 'Â¡50 kilÃ³metros acumulados!', 'Acumula 50 km de entrenamiento', 'ğŸ“', 'primary', 'distance', 'total_distance', 50, 50),
('Club de los 100', 'Â¡100 kilÃ³metros logrados!', 'Acumula 100 km de entrenamiento', 'ğŸ–ï¸', 'yellow', 'distance', 'total_distance', 100, 51),
('Devorador de KilÃ³metros', 'Â¡200 km bajo tus pies!', 'Acumula 200 km de entrenamiento', 'ğŸ†', 'orange', 'distance', 'total_distance', 200, 52),
('Leyenda 500K', 'Â¡Medio millar de kilÃ³metros!', 'Acumula 500 km de entrenamiento', 'ğŸ‘‘', 'gold', 'distance', 'total_distance', 500, 53),

-- High intensity achievements
('Sudor y Gloria', 'Â¡Intensidad al mÃ¡ximo!', 'Completa 5 actividades con intensidad 4-5', 'ğŸ’ª', 'primary', 'high_intensity', 'high_intensity_count', 5, 60),
('Forjado en Fuego', 'Â¡El esfuerzo te define!', 'Completa 15 actividades con intensidad 4-5', 'ğŸ”¥', 'orange', 'high_intensity', 'high_intensity_count', 15, 61),
('Guerrero del Dolor', 'Â¡La intensidad es tu aliada!', 'Completa 30 actividades con intensidad 4-5', 'âš”ï¸', 'red', 'high_intensity', 'high_intensity_count', 30, 62),

-- Special plan completion achievements
('10K Legend', 'Â¡Plan 10K completado!', 'Completa el plan de entrenamiento 10K', 'âš¡', 'gold', 'special', 'plan_complete_10k', 1, 70),
('Media MaratÃ³n', 'Â¡Plan 21K completado!', 'Completa el plan de entrenamiento 21K', 'ğŸš€', 'gold', 'special', 'plan_complete_21k', 1, 71),
('Maratonista', 'Â¡Plan 42K completado!', 'Completa el plan de entrenamiento 42K', 'â­', 'gold', 'special', 'plan_complete_42k', 1, 72);

-- Create index for better performance
CREATE INDEX idx_user_achievements_user_id ON public.user_achievements(user_id);
CREATE INDEX idx_achievements_category ON public.achievements(category);
CREATE INDEX idx_achievements_sort_order ON public.achievements(sort_order);